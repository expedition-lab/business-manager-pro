<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Business Manager Pro — App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    (function(){
      try{
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister()));
          if (window.caches && caches.keys) { caches.keys().then(keys => keys.forEach(k => caches.delete(k))); }
        }
      }catch(e){}
    })();
  </script>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="sticky top-0 z-30 bg-white border-b">
    <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/" class="font-semibold">Business Manager Pro</a>
      <div class="text-sm flex items-center gap-3">
        <span id="userEmail" class="hidden px-2 py-1 rounded-full border"></span>
        <button id="logoutBtn" class="hidden px-3 py-1.5 rounded-lg border">Sign out</button>
      </div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-6">
    <div id="diag" class="hidden mb-4 rounded-xl border border-red-300 bg-red-50 p-4 text-sm text-red-700"></div>

    <section id="authCard" class="rounded-xl border bg-white p-5">
      <h2 class="text-lg font-semibold">Create account / Sign in</h2>
      <div class="grid md:grid-cols-3 gap-3 mt-3">
        <input id="email" class="border rounded-lg p-2" placeholder="Email" autocomplete="username" inputmode="email">
        <input id="password" type="password" class="border rounded-lg p-2" placeholder="Password (min 6)" minlength="6" autocomplete="current-password">
        <div class="flex gap-2">
          <button id="signupBtn" class="flex-1 px-3 py-2 rounded-lg bg-blue-600 text-white">Create</button>
          <button id="loginBtn"  class="flex-1 px-3 py-2 rounded-lg border">Log in</button>
        </div>
      </div>

      <div class="mt-4 grid md:grid-cols-2 gap-3">
        <input id="fullName" class="border rounded-lg p-2" placeholder="Full name (required)">
        <input id="bizName"  class="border rounded-lg p-2" placeholder="Business name (required)">
        <input id="brn"      class="border rounded-lg p-2 uppercase" placeholder="BRN (required)">
        <input id="phone"    class="border rounded-lg p-2" placeholder="Phone (required)">
        <input id="address"  class="md:col-span-2 border rounded-lg p-2" placeholder="Business address (required)">
        <input id="vat"      class="border rounded-lg p-2" placeholder="VAT number (optional)">
        <select id="companyType" class="border rounded-lg p-2">
          <option value="">Company type (optional)</option>
          <option>Ltd</option><option>Sole Trader</option><option>Partnership</option><option>Other</option>
        </select>
      </div>

      <div class="mt-2 flex gap-2">
        <button id="loginOtpBtn" class="px-3 py-2 rounded-lg border" disabled title="Magic link disabled in proxy mode">Email me a login code</button>
      </div>
      <p id="authMsg" class="text-sm mt-2"></p>
    </section>

    <section id="payCard" class="hidden rounded-xl border bg-white p-5 mt-6">
      <h2 class="text-lg font-semibold">Choose your plan & pay</h2>
      <p class="text-sm text-slate-600">Pick a plan. Pay by PayPal or JUICE. Access activates after payment.</p>

      <div class="mt-4 grid md:grid-cols-3 gap-3" id="plansGrid">
        <button class="planBtn border rounded-lg p-3 text-left hover:bg-slate-50" data-tier="Starter" data-cycle="Monthly" data-amount="499">
          <div class="font-semibold">Starter — Monthly</div>
          <div class="text-sm text-slate-600">Rs 499 / month</div>
          <div class="text-xs text-slate-500 mt-1">Up to 100 receipts / mo</div>
        </button>
        <button class="planBtn border rounded-lg p-3 text-left hover:bg-slate-50" data-tier="Pro" data-cycle="Monthly" data-amount="899">
          <div class="font-semibold">Pro — Monthly</div>
          <div class="text-sm text-slate-600">Rs 899 / month</div>
          <div class="text-xs text-slate-500 mt-1">Unlimited receipts</div>
        </button>
        <button class="planBtn border rounded-lg p-3 text-left hover:bg-slate-50" data-tier="Pro" data-cycle="Yearly" data-amount="8500">
          <div class="font-semibold">Pro — Yearly</div>
          <div class="text-sm text-slate-600">Rs 8,500 / year</div>
          <div class="text-xs text-slate-500 mt-1">Save vs monthly</div>
        </button>
      </div>

      <div class="mt-4 rounded-lg border p-3 bg-slate-50 hidden" id="planSummary">
        <div class="text-sm">Selected plan:</div>
        <div class="font-semibold" id="planName">—</div>
        <div class="text-sm" id="planAmount">—</div>
      </div>

      <div class="grid md:grid-cols-2 gap-3 mt-4">
        <button id="paypalCopy" class="px-4 py-3 rounded-lg border">Pay with PayPal (copy email)</button>
        <button id="juiceBtn"   class="px-4 py-3 rounded-lg border">Pay with JUICE</button>
      </div>

      <div id="juiceModal" class="hidden fixed inset-0 bg-black/50 grid place-items-center p-4">
        <div class="max-w-md w-full bg-white rounded-xl p-5">
          <h3 class="font-semibold">JUICE payment</h3>
          <p class="text-sm text-slate-600 mt-1">Send to this JUICE number:</p>
          <div class="mt-3 flex items-center gap-2">
            <input id="juiceNumber" class="border rounded-lg p-2 w-full" value="23054960101" />
            <button id="copyJuice" class="px-3 py-2 rounded-lg border">Copy</button>
          </div>
          <div class="text-sm mt-3">Amount to pay: <span class="font-semibold" id="juiceAmount">—</span></div>
          <div class="flex justify-end gap-2 mt-4">
            <a id="callJuice" class="px-3 py-2 rounded-lg border" href="tel:+23054960101">Call</a>
            <a id="waJuice"   class="px-3 py-2 rounded-lg border" target="_blank">WhatsApp</a>
            <button id="closeJuice" class="px-3 py-2 rounded-lg bg-blue-600 text-white">Done</button>
          </div>
        </div>
      </div>

      <p id="payMsg" class="text-sm mt-3"></p>
    </section>

    <section id="recCard" class="hidden rounded-xl border bg-white p-5 mt-6">
      <h2 class="text-lg font-semibold">Quick receipt</h2>
      <div class="grid md:grid-cols-4 gap-3 mt-3">
        <input id="rec-client" class="border rounded-lg p-2" placeholder="Client name">
        <input id="rec-phone"  class="border rounded-lg p-2" placeholder="Client phone">
        <input id="rec-email"  class="border rounded-lg p-2" placeholder="Client email">
        <input id="rec-date"   class="border rounded-lg p-2" type="date">
      </div>
      <div class="grid md:grid-cols-3 gap-3 mt-3">
        <input id="rec-item"  class="border rounded-lg p-2" placeholder="Item">
        <input id="rec-price" class="border rounded-lg p-2" type="number" step="0.01" placeholder="Price (MUR)">
        <button id="saveBtn"  class="px-4 py-2 rounded-lg bg-blue-600 text-white">Save</button>
      </div>

      <div id="shareWrap" class="hidden mt-3 flex gap-2">
        <a id="shareWa"   target="_blank" class="px-3 py-2 rounded-lg border">Share via WhatsApp</a>
        <a id="shareMail"              class="px-3 py-2 rounded-lg border">Share via Email</a>
      </div>

      <p id="recMsg" class="text-sm mt-2"></p>
    </section>
  </main>

  <script>
    const $ = s => document.querySelector(s);
    const emailOk = v => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v||"");
    const phoneOk = v => /^\+?[0-9 ()-]{6,20}$/.test((v||"").trim());
    const brnOk   = v => /^[A-Z0-9-]{8,20}$/.test((v||"").toUpperCase().trim());
    const PAYPAL_EMAIL = "peeroosuhail047@gmail.com";
    const PRICES = { "Starter|Monthly": 499, "Pro|Monthly": 899, "Pro|Yearly": 8500 };
    const tokenKey = 'bmp_token';
    const setToken = t => localStorage.setItem(tokenKey, t);
    const getToken = () => localStorage.getItem(tokenKey);
    const clearToken = () => localStorage.removeItem(tokenKey);

    function msg(el, text, ok=false){ el.textContent=text; el.className='text-sm mt-2 '+(ok?'text-green-600':'text-red-600'); if(!ok) setTimeout(()=>{el.textContent='';},6000); }
    function showWhenSignedIn(user){
      const signedIn = !!user;
      $('#authCard').classList.toggle('hidden', signedIn);
      $('#payCard').classList.toggle('hidden', !signedIn);
      $('#recCard').classList.toggle('hidden', !signedIn);
      $('#logoutBtn').classList.toggle('hidden', !signedIn);
      $('#userEmail').classList.toggle('hidden', !signedIn);
      if (signedIn) $('#userEmail').textContent = user.email || '';
    }
    function showDiag(text){ const d=$('#diag'); d.textContent=text; d.classList.remove('hidden'); }

    // ---- API helpers (talk only to our own domain) ----
    async function api(path, method='POST', body=null){
      const headers = { 'Content-Type': 'application/json' };
      const token = getToken();
      if (token) headers['Authorization'] = 'Bearer ' + token;
      const r = await fetch(path, { method, headers, body: body ? JSON.stringify(body) : undefined });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }
    const apiSignup       = (p) => api('/api/signup','POST',p);
    const apiLogin        = (p) => api('/api/login','POST',p);
    const apiMe           = ()  => api('/api/me','GET');
    const apiUsersUpsert  = (p) => api('/api/users-upsert','POST',p);
    const apiReceiptsIns  = (p) => api('/api/receipts-insert','POST',p);

    // ---- Auth actions ----
    $('#signupBtn').onclick = async ()=>{
      const m=$('#authMsg'); m.textContent='';
      const email = $('#email').value.trim();
      const pass  = $('#password').value.trim();
      const fullName = $('#fullName').value.trim();
      const bizName  = $('#bizName').value.trim();
      const brn      = $('#brn').value.toUpperCase().trim();
      const phone    = $('#phone').value.trim();
      const address  = $('#address').value.trim();
      const vat      = $('#vat').value.trim();
      const ctype    = $('#companyType').value.trim();

      if(!emailOk(email))         return msg(m,'Enter a valid email');
      if(pass.length < 6)         return msg(m,'Password must be at least 6 characters');
      if(!fullName)               return msg(m,'Full name is required');
      if(!bizName)                return msg(m,'Business name is required');
      if(!brnOk(brn))             return msg(m,'BRN must be 8–20 chars, A–Z, 0–9, or "-"');
      if(!phoneOk(phone))         return msg(m,'Enter a valid phone number');
      if(!address)                return msg(m,'Business address is required');

      try{
        await apiSignup({ email, password: pass, data: { fullName, bizName, brn, phone, address, vat, ctype } });
        msg(m,'Account created ✓. If confirmation is ON, check your inbox.', true);
      }catch(e){ msg(m, e.message || 'Signup failed'); }
    };

    $('#loginBtn').onclick = async ()=>{
      const m=$('#authMsg'); m.textContent='';
      const email = $('#email').value.trim();
      const pass  = $('#password').value.trim();
      if(!emailOk(email)) return msg(m,'Enter a valid email');
      if(pass.length < 6) return msg(m,'Password must be at least 6 characters');
      try{
        const out = await apiLogin({ email, password: pass });
        if(!out.access_token) throw new Error('No access token');
        setToken(out.access_token);

        // ensure user row
        await apiUsersUpsert({ full_name: $('#fullName').value.trim(), business_name: $('#bizName').value.trim(),
                               brn: $('#brn').value.trim(), phone: $('#phone').value.trim(),
                               address: $('#address').value.trim(), vat_number: $('#vat').value.trim(),
                               company_type: $('#companyType').value.trim() });

        const me = await apiMe();
        showWhenSignedIn(me);
        msg(m,'Logged in ✓', true);
      }catch(e){ msg(m, e.message || 'Login failed'); }
    };

    $('#logoutBtn').onclick = async ()=>{ clearToken(); showWhenSignedIn(null); location.hash='#logout'; };

    // ---- Plans ----
    let selectedPlan = null;
    function setPlan(tier, cycle, amount){
      selectedPlan = { tier, cycle, amount };
      $('#planSummary').classList.remove('hidden');
      $('#planName').textContent = `${tier} — ${cycle}`;
      $('#planAmount').textContent = `Rs ${amount.toFixed(0)}`;
      $('#juiceAmount').textContent = `Rs ${amount.toFixed(0)}`;
      $('#waJuice').href = `https://wa.me/23054960101?text=Payment%20for%20BMP%20${encodeURIComponent(tier)}%20(${encodeURIComponent(cycle)})%20-%20Rs%20${amount.toFixed(0)}`;
      msg($('#payMsg'), `Pay Rs ${amount.toFixed(0)} via PayPal or JUICE to activate ${tier} (${cycle}).`, true);
      // save chosen tier/cycle on user row (best-effort)
      apiUsersUpsert({ plan_tier: tier, plan_cycle: cycle }).catch(()=>{});
    }
    document.querySelectorAll('.planBtn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.planBtn').forEach(b=>b.classList.remove('ring-2','ring-blue-600'));
        btn.classList.add('ring-2','ring-blue-600');
        const tier = btn.dataset.tier, cycle = btn.dataset.cycle;
        const amount = Number(btn.dataset.amount || PRICES[`${tier}|${cycle}`] || 0);
        setPlan(tier, cycle, amount);
      });
    });

    // ---- Payments UI ----
    $('#paypalCopy').onclick = ()=>{
      if(!selectedPlan){ return msg($('#payMsg'),'Please select a plan first'); }
      navigator.clipboard.writeText(PAYPAL_EMAIL);
      window.open('https://www.paypal.com/myaccount/transfer/send', '_blank');
      const btn = $('#paypalCopy'); btn.textContent='Email copied ✓';
      setTimeout(()=>btn.textContent='Pay with PayPal (copy email)', 1200);
    };
    $('#juiceBtn').onclick  = ()=>{ if(!selectedPlan){ msg($('#payMsg'),'Please select a plan first'); return;} $('#juiceModal').classList.remove('hidden'); };
    $('#closeJuice').onclick= ()=> $('#juiceModal').classList.add('hidden');
    $('#copyJuice').onclick = ()=>{ navigator.clipboard.writeText($('#juiceNumber').value); $('#copyJuice').textContent='Copied'; setTimeout(()=>$('#copyJuice').textContent='Copy',1200); };

    // ---- Receipts + share ----
    function buildReceiptText(r){
      const lines = [
        `Business Manager Pro Receipt`,
        `Ref: ${r.reference_number}`,
        `Client: ${r.client_name || "-"}`,
        `Phone: ${r.client_phone || "-"}`,
        `Email: ${r.client_email || "-"}`,
        `Date: ${new Date(r.date).toLocaleString()}`,
        `Item: ${r.items?.[0]?.name || "-"}`,
        `Total: Rs ${Number(r.total||0).toFixed(2)}`
      ];
      return lines.join('\n');
    }
    function updateShareLinks(r){
      const txt = buildReceiptText(r);
      $('#shareWa').href   = `https://wa.me/?text=${encodeURIComponent(txt)}`;
      const subject = encodeURIComponent(`Receipt ${r.reference_number}`);
      const body = encodeURIComponent(txt);
      $('#shareMail').href = `mailto:${encodeURIComponent(r.client_email||'')}?subject=${subject}&body=${body}`;
      $('#shareWrap').classList.remove('hidden');
    }
    $('#saveBtn').onclick = async ()=>{
      const m=$('#recMsg'); m.textContent='';
      if(!getToken()) return msg(m,'Sign in first');
      const subtotal = Number($('#rec-price').value||0);
      const payload = {
        reference_number: 'BMP-' + Date.now().toString().slice(-8),
        client_name:  $('#rec-client').value.trim(),
        client_phone: $('#rec-phone').value.trim(),
        client_email: $('#rec-email').value.trim(),
        date: $('#rec-date').value ? new Date($('#rec-date').value).toISOString() : new Date().toISOString(),
        subtotal, tax:0, discount:0, total:subtotal,
        items: [{ name: $('#rec-item').value.trim(), qty:1, price:subtotal }]
      };
      try{
        const out = await apiReceiptsIns(payload);
        const rec = Array.isArray(out) ? out[0] : out;
        msg(m,'Saved ✓', true);
        updateShareLinks(rec || payload);
      }catch(e){ msg(m, e.message || 'Save failed'); }
    };

    // ---- Boot ----
    async function boot(){
      const token = getToken();
      if(!token){ showWhenSignedIn(null); return; }
      try{
        const me = await apiMe();
        showWhenSignedIn(me);
      }catch(_){ showWhenSignedIn(null); clearToken(); }
    }
    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
