<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Business Manager Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    window.SUPABASE_URL = "https://hppgouoexhqgecntpkei.supabase.co";
    window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhwcGdvdW9leGhxZ2VjbnRwa2VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyMzUzMDQsImV4cCI6MjA3NDgxMTMwNH0.twfjnJ7uirm4FaQBr4wFqT9KW-cH_lrqohA66oWNFJo";
  </script>
</head>
<body class="bg-slate-50 text-slate-800">
  
  <!-- HEADER -->
  <header class="sticky top-0 z-30 bg-white border-b">
    <div class="max-w-7xl mx-auto px-4 py-3">
      <div class="flex items-center justify-between">
        <a href="/" class="text-xl font-bold">Business Manager Pro</a>
        <div id="navTabs" class="hidden flex gap-2">
          <button onclick="showSection('dashboard')" id="dashboardBtn" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">Dashboard</button>
          <button onclick="showSection('receipts')" id="receiptsBtn" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg">Receipts</button>
          <button onclick="showSection('clients')" id="clientsBtn" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">Clients</button>
          <button onclick="showSection('create')" id="createBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">+ New Receipt</button>
        </div>
        <div class="flex items-center gap-3">
          <span id="userEmail" class="hidden text-sm px-3 py-1 rounded-full border"></span>
          <button id="logoutBtn" class="hidden px-3 py-1.5 rounded-lg border text-sm">Sign out</button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    
    <!-- AUTH SECTION -->
    <section id="authCard" class="rounded-xl border bg-white p-6 max-w-2xl mx-auto">
      <h2 class="text-2xl font-bold mb-4">Create account / Sign in</h2>
      <div class="grid md:grid-cols-3 gap-3">
        <input id="email" class="border rounded-lg p-2" placeholder="Email" />
        <input id="password" type="password" class="border rounded-lg p-2" placeholder="Password (min 8)" />
        <div class="flex gap-2">
          <button id="signupBtn" class="flex-1 px-3 py-2 rounded-lg bg-blue-600 text-white">Create</button>
          <button id="loginBtn" class="flex-1 px-3 py-2 rounded-lg border">Log in</button>
        </div>
      </div>
      <div class="mt-4 grid md:grid-cols-2 gap-3">
        <input id="fullName" class="border rounded-lg p-2" placeholder="Full name" />
        <input id="bizName" class="border rounded-lg p-2" placeholder="Business name" />
        <input id="brn" class="border rounded-lg p-2 uppercase" placeholder="BRN" />
        <input id="phone" class="border rounded-lg p-2" placeholder="Phone" />
        <input id="address" class="md:col-span-2 border rounded-lg p-2" placeholder="Address" />
      </div>
      <p id="authMsg" class="text-sm mt-2"></p>
    </section>

    <!-- DASHBOARD -->
    <section id="dashCard" class="hidden">
      <h2 class="text-2xl font-bold mb-6">Dashboard</h2>
      <div class="grid md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-sm p-6">
          <p class="text-sm text-gray-600">This Month Revenue</p>
          <p class="text-3xl font-bold" id="monthRevenue">Rs 0</p>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-6">
          <p class="text-sm text-gray-600">Total Receipts</p>
          <p class="text-3xl font-bold" id="totalReceipts">0</p>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-6">
          <p class="text-sm text-gray-600">Total Clients</p>
          <p class="text-3xl font-bold" id="totalClients">0</p>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-6">
          <p class="text-sm text-gray-600">Unpaid</p>
          <p class="text-3xl font-bold text-red-600" id="unpaidAmount">Rs 0</p>
        </div>
      </div>
      <div class="grid md:grid-cols-2 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-sm p-6">
          <h3 class="text-lg font-semibold mb-4">Revenue Trend</h3>
          <canvas id="revenueChart"></canvas>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-6">
          <h3 class="text-lg font-semibold mb-4">Payment Status</h3>
          <canvas id="paymentChart"></canvas>
        </div>
      </div>
    </section>

    <!-- CLIENTS -->
    <section id="clientsCard" class="hidden">
      <div class="bg-white rounded-xl shadow-sm p-6">
        <h2 class="text-xl font-semibold mb-6">All Clients</h2>
        <div id="clientsList"></div>
      </div>
    </section>

    <!-- RECEIPTS LIST -->
    <section id="receiptsCard" class="hidden">
      <div class="bg-white rounded-xl shadow-sm p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-semibold">Your Receipts</h2>
          <button id="exportCsvBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Export CSV</button>
        </div>
        <div id="receiptsTable" class="overflow-x-auto"></div>
      </div>
    </section>

    <!-- CREATE RECEIPT -->
    <section id="createCard" class="hidden">
      <div class="bg-white rounded-xl shadow-sm p-6">
        <h2 class="text-xl font-semibold mb-6">Create Receipt</h2>
        <form id="receiptForm" onsubmit="saveReceipt(event)">
          <div class="grid md:grid-cols-3 gap-4 mb-6">
            <input id="clientName" class="border rounded-lg p-2" placeholder="Client name" required />
            <input id="clientEmail" type="email" class="border rounded-lg p-2" placeholder="Client email" />
            <input id="clientPhone" class="border rounded-lg p-2" placeholder="Client phone" />
          </div>
          <div class="grid md:grid-cols-2 gap-4 mb-6">
            <select id="currency" class="border rounded-lg p-2">
              <option value="MUR">MUR (Rs)</option>
              <option value="USD">USD ($)</option>
              <option value="EUR">EUR (€)</option>
            </select>
            <select id="paymentStatus" class="border rounded-lg p-2">
              <option value="unpaid">Unpaid</option>
              <option value="paid">Paid</option>
              <option value="partial">Partial</option>
            </select>
          </div>
          <div class="mb-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-medium">Items</h3>
              <button type="button" onclick="addItemRow()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm">+ Add Item</button>
            </div>
            <div id="itemsContainer"></div>
          </div>
          <div class="flex justify-between items-center">
            <div class="text-right">
              <p class="text-sm text-gray-600">Total</p>
              <p class="text-2xl font-bold"><span id="currencySymbol">Rs</span> <span id="totalAmount">0.00</span></p>
            </div>
            <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Receipt</button>
          </div>
        </form>
      </div>
    </section>

  </main>

  <script>
    const $ = s => document.querySelector(s);
    const supabase = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
    
    let revenueChart = null;
    let paymentChart = null;
    
    const currencySymbols = { 'MUR': 'Rs', 'USD': '$', 'EUR': '€', 'GBP': '£' };

    function msg(el, text, ok=false){ 
      el.textContent=text; 
      el.className='text-sm mt-2 '+(ok?'text-green-600':'text-red-600'); 
    }

    function renderAuthState(session){
      const signedIn = !!session?.user;
      $('#authCard').classList.toggle('hidden', signedIn);
      $('#navTabs').classList.toggle('hidden', !signedIn);
      $('#logoutBtn').classList.toggle('hidden', !signedIn);
      $('#userEmail').classList.toggle('hidden', !signedIn);
      if (signedIn) {
        $('#userEmail').textContent = session.user.email || '';
        showSection('receipts');
      }
    }

    supabase.auth.getSession().then(({ data }) => renderAuthState(data.session));
    supabase.auth.onAuthStateChange((_evt, session) => {
      renderAuthState(session);
      if (session) loadReceipts();
    });

    $('#signupBtn').onclick = async ()=>{
      const m=$('#authMsg');
      const email = $('#email').value.trim();
      const pass = $('#password').value.trim();
      const fullName = $('#fullName').value.trim();
      const bizName = $('#bizName').value.trim();
      const brn = $('#brn').value.toUpperCase().trim();
      const phone = $('#phone').value.trim();
      const address = $('#address').value.trim();

      if(!email || pass.length < 8 || !fullName || !bizName) return msg(m,'Fill all required fields');

      const { data: signUp, error: signUpErr } = await supabase.auth.signUp({
        email, password: pass,
        options: { emailRedirectTo: location.origin }
      });
      if (signUpErr) return msg(m, signUpErr.message);

      const { error: insErr } = await supabase
        .from('business_profiles')
        .insert([{
          user_id: signUp.user?.id,
          email, full_name: fullName, business_name: bizName,
          brn, phone, address
        }]);
      if (insErr) return msg(m, insErr.message);

      msg(m,'Account created! Check your email.', true);
    };

    $('#loginBtn').onclick = async ()=>{
      const m=$('#authMsg');
      const email = $('#email').value.trim();
      const pass = $('#password').value.trim();
      if(!email || pass.length < 8) return msg(m,'Enter email and password');

      const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
      if (error) return msg(m, error.message);
      msg(m,'Logged in!', true);
    };

    $('#logoutBtn').onclick = async ()=>{ await supabase.auth.signOut(); };

    function showSection(section) {
      ['authCard','dashCard','receiptsCard','clientsCard','createCard'].forEach(id => {
        $(id).classList.add('hidden');
      });
      ['dashboardBtn','receiptsBtn','clientsBtn'].forEach(id => {
        const btn = $(id);
        if(btn) btn.className = 'px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg';
      });

      if (section === 'dashboard') {
        $('#dashCard').classList.remove('hidden');
        $('#dashboardBtn').className = 'px-4 py-2 bg-blue-100 text-blue-700 rounded-lg';
        loadDashboard();
      } else if (section === 'receipts') {
        $('#receiptsCard').classList.remove('hidden');
        $('#receiptsBtn').className = 'px-4 py-2 bg-blue-100 text-blue-700 rounded-lg';
        loadReceipts();
      } else if (section === 'clients') {
        $('#clientsCard').classList.remove('hidden');
        $('#clientsBtn').className = 'px-4 py-2 bg-blue-100 text-blue-700 rounded-lg';
        loadClients();
      } else if (section === 'create') {
        $('#createCard').classList.remove('hidden');
      }
    }

    async function loadDashboard() {
      const session = (await supabase.auth.getSession()).data.session;
      if (!session) return;
      
      const { data: receipts } = await supabase
        .from('receipts')
        .select('*')
        .eq('user_id', session.user.id);
      
      if (!receipts) return;
      
      const now = new Date();
      const thisMonth = receipts.filter(r => {
        const d = new Date(r.date);
        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
      });
      
      const monthRev = thisMonth.reduce((sum, r) => sum + Number(r.total || 0), 0);
      $('#monthRevenue').textContent = `Rs ${monthRev.toFixed(2)}`;
      $('#totalReceipts').textContent = receipts.length;
      
      const clients = new Set(receipts.map(r => r.client_name).filter(Boolean));
      $('#totalClients').textContent = clients.size;
      
      const unpaid = receipts.filter(r => !r.payment_status || r.payment_status === 'unpaid' || r.payment_status === 'partial');
      const unpaidAmount = unpaid.reduce((sum, r) => sum + Number(r.total || 0), 0);
      $('#unpaidAmount').textContent = `Rs ${unpaidAmount.toFixed(2)}`;
      
      // Charts
      const last6Months = [];
      for (let i = 5; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const monthReceipts = receipts.filter(r => {
          const rDate = new Date(r.date);
          return rDate.getMonth() === date.getMonth() && rDate.getFullYear() === date.getFullYear();
        });
        last6Months.push({
          month: date.toLocaleDateString('en', { month: 'short' }),
          revenue: monthReceipts.reduce((sum, r) => sum + Number(r.total || 0), 0)
        });
      }
      
      if (revenueChart) revenueChart.destroy();
      const ctx1 = $('#revenueChart').getContext('2d');
      revenueChart = new Chart(ctx1, {
        type: 'line',
        data: {
          labels: last6Months.map(m => m.month),
          datasets: [{
            label: 'Revenue (Rs)',
            data: last6Months.map(m => m.revenue),
            borderColor: 'rgb(59, 130, 246)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4
          }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });
      
      const paid = receipts.filter(r => r.payment_status === 'paid').length;
      const unpaidCount = receipts.filter(r => !r.payment_status || r.payment_status === 'unpaid').length;
      const partial = receipts.filter(r => r.payment_status === 'partial').length;
      
      if (paymentChart) paymentChart.destroy();
      const ctx2 = $('#paymentChart').getContext('2d');
      paymentChart = new Chart(ctx2, {
        type: 'doughnut',
        data: {
          labels: ['Paid', 'Unpaid', 'Partial'],
          datasets: [{
            data: [paid, unpaidCount, partial],
            backgroundColor: ['rgb(34, 197, 94)', 'rgb(239, 68, 68)', 'rgb(251, 191, 36)']
          }]
        },
        options: { responsive: true }
      });
    }

    async function loadClients() {
      const session = (await supabase.auth.getSession()).data.session;
      if (!session) return;
      
      const { data: receipts } = await supabase
        .from('receipts')
        .select('*')
        .eq('user_id', session.user.id);
      
      if (!receipts || receipts.length === 0) {
        $('#clientsList').innerHTML = '<p class="text-gray-500 text-center py-8">No clients yet</p>';
        return;
      }
      
      const clientData = {};
      receipts.forEach(r => {
        if (!clientData[r.client_name]) {
          clientData[r.client_name] = {
            name: r.client_name,
            email: r.client_email || '',
            phone: r.client_phone || '',
            receipts: [],
            total: 0
          };
        }
        clientData[r.client_name].receipts.push(r);
        clientData[r.client_name].total += Number(r.total || 0);
      });
      
      const clients = Object.values(clientData).sort((a, b) => b.total - a.total);
      
      $('#clientsList').innerHTML = `
        <div class="grid gap-4">
          ${clients.map(client => `
            <div class="border-2 rounded-xl p-6 hover:shadow-lg transition bg-white">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <h3 class="font-bold text-xl mb-2">${client.name}</h3>
                  ${client.email ? `<p class="text-sm text-gray-600">📧 ${client.email}</p>` : ''}
                  ${client.phone ? `<p class="text-sm text-gray-600">📱 ${client.phone}</p>` : ''}
                </div>
                <div class="text-right">
                  <p class="text-2xl font-bold text-green-600">Rs ${client.total.toFixed(2)}</p>
                  <p class="text-sm text-gray-600">${client.receipts.length} receipts</p>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    async function loadReceipts() {
      const session = (await supabase.auth.getSession()).data.session;
      if (!session) return;
      
      const { data, error } = await supabase
        .from('receipts')
        .select('*')
        .eq('user_id', session.user.id)
        .order('created_at', { ascending: false })
        .limit(50);
      
      if (error) { console.error(error); return; }
      
      if (!data || data.length === 0) {
        $('#receiptsTable').innerHTML = '<p class="text-gray-500 text-center py-8">No receipts yet</p>';
        return;
      }
      
      $('#receiptsTable').innerHTML = `
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">REF</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">CLIENT</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">DATE</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">TOTAL</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">STATUS</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">ACTIONS</th>
            </tr>
          </thead>
          <tbody>
            ${data.map(r => `
              <tr class="border-b hover:bg-gray-50">
                <td class="px-4 py-3 text-sm font-mono">${r.reference_number}</td>
                <td class="px-4 py-3 text-sm">${r.client_name || '-'}</td>
                <td class="px-4 py-3 text-sm">${new Date(r.date).toLocaleDateString()}</td>
                <td class="px-4 py-3 text-sm font-semibold">Rs ${Number(r.total).toFixed(2)}</td>
                <td class="px-4 py-3 text-sm">
                  <span class="px-2 py-1 rounded text-xs font-medium ${
                    r.payment_status === 'paid' ? 'bg-green-100 text-green-800' :
                    r.payment_status === 'partial' ? 'bg-yellow-100 text-yellow-800' :
                    'bg-red-100 text-red-800'
                  }">
                    ${(r.payment_status || 'unpaid').toUpperCase()}
                  </span>
                </td>
                <td class="px-4 py-3 text-sm">
                  <button onclick="downloadPDF('${r.id}')" class="text-blue-600 hover:underline">Download</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function addItemRow() {
      const container = $('#itemsContainer');
      const itemId = Date.now() + Math.random();
      const itemRow = document.createElement('div');
      itemRow.className = 'grid grid-cols-12 gap-3 mb-3';
      itemRow.id = `item-${itemId}`;
      itemRow.innerHTML = `
        <div class="col-span-5">
          <input type="text" class="item-description w-full border rounded-lg p-2" placeholder="Description" required oninput="calculateTotal()" />
        </div>
        <div class="col-span-2">
          <input type="number" class="item-quantity w-full border rounded-lg p-2" value="1" min="1" required oninput="calculateTotal()" />
        </div>
        <div class="col-span-3">
          <input type="number" class="item-price w-full border rounded-lg p-2" value="0" min="0" step="0.01" required oninput="calculateTotal()" />
        </div>
        <div class="col-span-2">
          <button type="button" onclick="removeItem('${itemId}')" class="w-full px-3 py-2 bg-red-100 text-red-600 rounded-lg">Remove</button>
        </div>
      `;
      container.appendChild(itemRow);
      calculateTotal();
    }

    function removeItem(itemId) {
      document.getElementById(`item-${itemId}`).remove();
      calculateTotal();
    }

    function calculateTotal() {
      const items = document.querySelectorAll('#itemsContainer > div');
      let total = 0;
      items.forEach(item => {
        const quantity = parseFloat(item.querySelector('.item-quantity').value) || 0;
        const price = parseFloat(item.querySelector('.item-price').value) || 0;
        total += quantity * price;
      });
      const currency = $('#currency').value;
      $('#currencySymbol').textContent = currencySymbols[currency];
      $('#totalAmount').textContent = total.toFixed(2);
    }

    function getReceiptItems() {
      const items = [];
      document.querySelectorAll('#itemsContainer > div').forEach(row => {
        const description = row.querySelector('.item-description').value;
        const quantity = parseFloat(row.querySelector('.item-quantity').value);
        const price = parseFloat(row.querySelector('.item-price').value);
        if (description && quantity > 0 && price >= 0) {
          items.push({ name: description, qty: quantity, price });
        }
      });
      return items;
    }

    async function saveReceipt(event) {
      event.preventDefault();
      const session = (await supabase.auth.getSession()).data.session;
      if (!session) return alert('Please sign in first');

      const items = getReceiptItems();
      if (items.length === 0) return alert('Add at least one item');

      const total = parseFloat($('#totalAmount').textContent);
      const payload = {
        user_id: session.user.id,
        reference_number: 'BMP-' + Date.now().toString().slice(-8),
        client_name: $('#clientName').value.trim(),
        client_email: $('#clientEmail').value.trim(),
        client_phone: $('#clientPhone').value.trim(),
        date: new Date().toISOString(),
        subtotal: total,
        tax: 0,
        discount: 0,
        total,
        items,
        payment_status: $('#paymentStatus').value
      };

      const { error } = await supabase.from('receipts').insert([payload]);
      if (error) return alert('Error: ' + error.message);

      alert('Receipt saved!');
      $('#receiptForm').reset();
      $('#itemsContainer').innerHTML = '';
      addItemRow();
      showSection('receipts');
    }

    window.downloadPDF = async function(receiptId) {
      const { data: receipt } = await supabase.from('receipts').select('*').eq('id', receiptId).single();
      const { data: profile } = await supabase.from('business_profiles').select('*').eq('user_id', receipt.user_id).single();
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      doc.setFontSize(20);
      doc.text(profile?.business_name || 'Business', 20, 20);
      doc.setFontSize(10);
      doc.text(`BRN: ${profile?.brn || '-'}`, 20, 30);
      doc.text(profile?.address || '', 20, 35);
      
      doc.setFontSize(16);
      doc.text('RECEIPT', 20, 50);
      doc.setFontSize(10);
      doc.text(`Ref: ${receipt.reference_number}`, 20, 60);
      doc.text(`Date: ${new Date(receipt.date).toLocaleDateString()}`, 20, 65);
      doc.text(`Client: ${receipt.client_name || '-'}`, 20, 75);
      
      let y = 90;
      (receipt.items || []).forEach(item => {
        doc.text(`${item.name || '-'} - Rs ${item.price || 0}`, 20, y);
        y += 7;
      });
      
      y += 10;
      doc.setFontSize(14);
      doc.text(`TOTAL: Rs ${receipt.total}`, 20, y);
      
      doc.save(`${receipt.reference_number}.pdf`);
    }

    $('#exportCsvBtn').onclick = async () => {
      const session = (await supabase.auth.getSession()).data.session;
      if (!session) return;
      
      const { data: receipts } = await supabase.from('receipts').select('*').eq('user_id', session.user.id);
      if (!receipts || receipts.length === 0) return alert('No receipts to export');
      
      const headers = ['Reference', 'Client', 'Date', 'Total', 'Status'];
      const rows = receipts.map(r => [
        r.reference_number,
        r.client_name || '',
        new Date(r.date).toLocaleDateString(),
        r.total || 0,
        r.payment_status || 'unpaid'
      ]);
      
      let csvContent = headers.join(',') + '\n';
      rows.forEach(row => csvContent += row.map(cell => `"${cell}"`).join(',') + '\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `receipts-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    };

    window.addEventListener('DOMContentLoaded', () => addItemRow());
  </script>
</body>
</html>
