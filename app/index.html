<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Business Manager Pro — App</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="sticky top-0 z-30 bg-white border-b">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/" class="font-semibold">Business Manager Pro</a>
      <div class="text-sm flex items-center gap-3">
        <span id="userEmail" class="hidden px-2 py-1 rounded-full border"></span>
        <button id="logoutBtn" class="hidden px-3 py-1.5 rounded-lg border">Sign out</button>
      </div>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 py-6">
    <!-- AUTH -->
    <section id="authCard" class="rounded-xl border bg-white p-5">
      <h2 class="text-lg font-semibold">Sign in</h2>
      <div class="grid md:grid-cols-3 gap-3 mt-3">
        <input id="email" class="border rounded-lg p-2" placeholder="Email">
        <input id="password" type="password" class="border rounded-lg p-2" placeholder="Password">
        <div class="flex gap-2">
          <button id="signupBtn" class="flex-1 px-3 py-2 rounded-lg bg-blue-600 text-white">Create</button>
          <button id="loginBtn"  class="flex-1 px-3 py-2 rounded-lg border">Log in</button>
        </div>
      </div>
      <p id="authMsg" class="text-sm text-red-600 mt-2"></p>
    </section>

    <!-- QUICK PAYMENTS -->
    <section id="payCard" class="hidden rounded-xl border bg-white p-5 mt-6">
      <h2 class="text-lg font-semibold">Payment methods</h2>
      <p class="text-sm text-slate-600">Choose a subscription payment option.</p>

      <div class="grid md:grid-cols-2 gap-3 mt-3">
        <!-- PayPal (replace link with your real one) -->
        <a id="paypalBtn"
           href="https://www.paypal.com/paypalme/YOURHANDLE/1499MUR"
           target="_blank" rel="noopener"
           class="px-4 py-3 rounded-lg bg-blue-600 text-white text-center">
          Pay with PayPal
        </a>

        <!-- JUICE -->
        <button id="juiceBtn" class="px-4 py-3 rounded-lg border">Pay with JUICE</button>
      </div>

      <!-- JUICE modal -->
      <div id="juiceModal"
           class="hidden fixed inset-0 bg-black/50 grid place-items-center p-4">
        <div class="max-w-md w-full bg-white rounded-xl p-5">
          <h3 class="font-semibold">JUICE payment</h3>
          <p class="text-sm text-slate-600 mt-1">Send to this number:</p>
          <div class="mt-3 flex items-center gap-2">
            <input id="juiceNumber" class="border rounded-lg p-2 w-full" value="+230 5XX XX XX" />
            <button id="copyJuice" class="px-3 py-2 rounded-lg border">Copy</button>
          </div>
          <div class="flex justify-end gap-2 mt-4">
            <a id="callJuice" class="px-3 py-2 rounded-lg border" href="tel:+2305XXXXXXXX">Call</a>
            <button id="closeJuice" class="px-3 py-2 rounded-lg bg-blue-600 text-white">Done</button>
          </div>
        </div>
      </div>
    </section>

    <!-- MIN RECEIPT (optional demo) -->
    <section id="recCard" class="hidden rounded-xl border bg-white p-5 mt-6">
      <h2 class="text-lg font-semibold">Quick receipt</h2>
      <div class="grid md:grid-cols-4 gap-3 mt-3">
        <input id="rec-client" class="border rounded-lg p-2" placeholder="Client name">
        <input id="rec-phone"  class="border rounded-lg p-2" placeholder="Client phone">
        <input id="rec-email"  class="border rounded-lg p-2" placeholder="Client email">
        <input id="rec-date"   class="border rounded-lg p-2" type="date">
      </div>
      <div class="grid md:grid-cols-3 gap-3 mt-3">
        <input id="rec-item"  class="border rounded-lg p-2" placeholder="Item">
        <input id="rec-price" class="border rounded-lg p-2" type="number" step="0.01" placeholder="Price (MUR)">
        <button id="saveBtn"  class="px-4 py-2 rounded-lg bg-blue-600 text-white">Save</button>
      </div>
      <p id="recMsg" class="text-sm mt-2"></p>
    </section>
  </main>

  <!-- libs -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <script>
    // ===== Supabase (YOUR real values already filled) =====
    const SUPABASE_URL = "https://hppgouoexhqgecntpkei.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_9rkxf2R-S7a4yd24O5q9yQ_vH6xGz3g";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // helpers
    const $ = (s)=>document.querySelector(s);

    function showWhenSignedIn(user){
      const signedIn = !!user;
      $('#authCard').classList.toggle('hidden', signedIn);
      $('#payCard').classList.toggle('hidden', !signedIn);
      $('#recCard').classList.toggle('hidden', !signedIn);
      $('#logoutBtn').classList.toggle('hidden', !signedIn);
      $('#userEmail').classList.toggle('hidden', !signedIn);
      if (signedIn) $('#userEmail').textContent = user.email || '';
    }

    // auth actions
    async function ensureProfile(){
      const { data: { user } } = await sb.auth.getUser();
      if(user){
        await sb.from('users').upsert(
          { id: user.id, email: user.email, subscription_status: 'trial' },
          { onConflict: 'id' }
        );
      }
    }

    $('#signupBtn').onclick = async ()=>{
      $('#authMsg').textContent='';
      const email = $('#email').value.trim();
      const pass  = $('#password').value.trim();
      const { error } = await sb.auth.signUp({ email, password: pass });
      if(error){ $('#authMsg').textContent = error.message; return; }
      await ensureProfile(); boot();
    };

    $('#loginBtn').onclick = async ()=>{
      $('#authMsg').textContent='';
      const email = $('#email').value.trim();
      const pass  = $('#password').value.trim();
      const { error } = await sb.auth.signInWithPassword({ email, password: pass });
      if(error){ $('#authMsg').textContent = error.message; return; }
      await ensureProfile(); boot();
    };

    $('#logoutBtn').onclick = async ()=>{ await sb.auth.signOut(); boot(); };

    // quick receipt (single item)
    $('#saveBtn').onclick = async ()=>{
      const { data:{ user } } = await sb.auth.getUser();
      if(!user){ $('#recMsg').textContent = 'Sign in first'; return; }
      const subtotal = Number($('#rec-price').value||0);
      const payload = {
        user_id: user.id,
        reference_number: 'BMP-' + Date.now().toString().slice(-8),
        client_name:  $('#rec-client').value.trim(),
        client_phone: $('#rec-phone').value.trim(),
        client_email: $('#rec-email').value.trim(),
        date: $('#rec-date').value ? new Date($('#rec-date').value).toISOString() : new Date().toISOString(),
        subtotal, tax:0, discount:0, total:subtotal,
        items: [{ name: $('#rec-item').value.trim(), qty:1, price:subtotal }]
      };
      const { error } = await sb.from('receipts').insert(payload);
      $('#recMsg').textContent = error ? error.message : 'Saved ✓';
    };

    // JUICE modal
    $('#juiceBtn').onclick = ()=> $('#juiceModal').classList.remove('hidden');
    $('#closeJuice').onclick = ()=> $('#juiceModal').classList.add('hidden');
    $('#copyJuice').onclick = ()=>{
      navigator.clipboard.writeText($('#juiceNumber').value);
      $('#copyJuice').textContent = 'Copied';
      setTimeout(()=>$('#copyJuice').textContent='Copy', 1200);
    };

    async function boot(){
      const { data:{ user } } = await sb.auth.getUser();
      showWhenSignedIn(user);
    }
    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
