<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Business Manager Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    window.SUPABASE_URL = "https://hppgouoexhqgecntpkei.supabase.co";
    window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhwcGdvdW9leGhxZ2VjbnRwa2VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyMzUzMDQsImV4cCI6MjA3NDgxMTMwNH0.twfjnJ7uirm4FaQBr4wFqT9KW-cH_lrqohA66oWNFJo";
  </script>
</head>
<body class="bg-gray-50">
  
  <!-- HEADER -->
  <div class="bg-white shadow-sm border-b sticky top-0 z-10">
    <div class="container mx-auto px-4 py-4">
      <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-800">Business Manager Pro</h1>
        <div id="navTabs" class="hidden flex gap-3">
          <button onclick="showSection('dashboard')" id="dashboardBtn" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition">ðŸ“Š Dashboard</button>
          <button onclick="showSection('receipts')" id="receiptsBtn" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg transition">ðŸ“„ Receipts</button>
          <button onclick="showSection('clients')" id="clientsBtn" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition">ðŸ‘¥ Clients</button>
          <button onclick="showSection('create')" id="createBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">+ New Receipt</button>
        </div>
        <div class="flex items-center gap-3">
          <span id="userEmail" class="hidden text-sm px-3 py-1 rounded-full border"></span>
          <button id="logoutBtn" class="hidden px-3 py-1.5 rounded-lg border text-sm hover:bg-gray-50">Sign out</button>
        </div>
      </div>
    </div>
  </div>

  <div class="container mx-auto px-4 py-8 max-w-7xl">
    
    <!-- AUTH SECTION -->
    <section id="authCard" class="rounded-xl border bg-white p-6 max-w-2xl mx-auto shadow-sm">
      <h2 class="text-2xl font-bold mb-4">Create account / Sign in</h2>
      <div class="grid md:grid-cols-3 gap-3">
        <input id="email" type="email" class="border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Email" />
        <input id="password" type="password" class="border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Password (min 8)" />
        <div class="flex gap-2">
          <button id="signupBtn" class="flex-1 px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition">Create</button>
          <button id="loginBtn" class="flex-1 px-3 py-2 rounded-lg border hover:bg-gray-50 transition">Log in</button>
        </div>
      </div>
      <div class="mt-4 grid md:grid-cols-2 gap-3">
        <input id="fullName" class="border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Full name" />
        <input id="bizName" class="border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Business name" />
        <input id="brn" class="border rounded-lg p-2 uppercase focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="BRN" />
        <input id="phone" class="border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Phone" />
        <input id="address" class="md:col-span-2 border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Address" />
      </div>
      <button id="resetPasswordBtn" class="mt-3 text-sm text-blue-600 hover:underline">Forgot password?</button>
      <p id="authMsg" class="text-sm mt-2"></p>
    </section>

    <!-- DASHBOARD -->
    <div id="dashboardSection" style="display: none;">
      <h2 class="text-2xl font-bold mb-6">Dashboard</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition">
          <p class="text-sm text-gray-600">Total Revenue</p>
          <p class="text-3xl font-bold text-gray-900" id="monthRevenue">Rs 0</p>
          <p class="text-sm text-green-600 mt-2">This month</p>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition">
          <p class="text-sm text-gray-600">Total Receipts</p>
          <p class="text-3xl font-bold text-gray-900" id="totalReceipts">0</p>
          <p class="text-sm text-blue-600 mt-2">All time</p>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition">
          <p class="text-sm text-gray-600">Total Clients</p>
          <p class="text-3xl font-bold text-gray-900" id="totalClients">0</p>
          <p class="text-sm text-purple-600 mt-2">Active</p>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition">
          <p class="text-sm text-gray-600">Unpaid</p>
          <p class="text-3xl font-bold text-red-600" id="unpaidAmount">Rs 0</p>
          <p class="text-sm text-gray-600 mt-2">Outstanding</p>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-sm p-6">
          <h3 class="text-lg font-semibold mb-4">Revenue Trend</h3>
          <canvas id="revenueChart"></canvas>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-6">
          <h3 class="text-lg font-semibold mb-4">Payment Status</h3>
          <canvas id="paymentChart"></canvas>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-6">
        <h3 class="text-lg font-semibold mb-4">Top Clients</h3>
        <div id="topClients"></div>
      </div>
    </div>

    <!-- CLIENTS -->
    <div id="clientsSection" style="display: none;">
      <div class="bg-white rounded-xl shadow-sm p-6">
        <h2 class="text-xl font-semibold mb-6">All Clients</h2>
        <div id="clientsList"></div>
      </div>
    </div>

    <!-- RECEIPTS LIST -->
    <div id="receiptsSection" style="display: none;">
      <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-semibold">All Receipts</h2>
          <div class="flex gap-2">
            <button onclick="generateMonthlyReport()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">ðŸ“Š Monthly Report</button>
            <button id="exportCsvBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">ðŸ“¥ Export CSV</button>
          </div>
        </div>
        <div id="receiptsTable" class="overflow-x-auto"></div>
      </div>
    </div>

    <!-- CREATE RECEIPT -->
    <div id="createSection" style="display: none;">
      <div class="bg-white rounded-xl shadow-sm p-6">
        <h2 class="text-xl font-semibold mb-6">Create Receipt</h2>
        <form id="receiptForm" onsubmit="saveReceipt(event)">
          <div class="grid md:grid-cols-3 gap-4 mb-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Client Name *</label>
              <input id="clientName" class="border rounded-lg p-2 w-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Client name" required />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
              <input id="clientEmail" type="email" class="border rounded-lg p-2 w-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="client@example.com" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
              <input id="clientPhone" type="tel" class="border rounded-lg p-2 w-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="+230 5XXX XXXX" />
            </div>
          </div>
          <div class="grid md:grid-cols-2 gap-4 mb-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Currency</label>
              <select id="currency" class="border rounded-lg p-2 w-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="calculateTotal()">
                <option value="MUR">MUR (Rs)</option>
                <option value="USD">USD ($)</option>
                <option value="EUR">EUR (â‚¬)</option>
                <option value="GBP">GBP (Â£)</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
              <select id="paymentStatus" class="border rounded-lg p-2 w-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="unpaid">Unpaid</option>
                <option value="paid">Paid</option>
                <option value="partial">Partial</option>
              </select>
            </div>
          </div>
          <div class="mb-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-medium">Items</h3>
              <button type="button" onclick="addItemRow()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition">+ Add Item</button>
            </div>
            <div id="itemsContainer"></div>
          </div>
          <div class="flex justify-between items-center">
            <div class="text-right">
              <p class="text-sm text-gray-600">Total Amount</p>
              <p class="text-2xl font-bold"><span id="currencySymbol">Rs</span> <span id="totalAmount">0.00</span></p>
            </div>
            <button type="submit" id="saveReceiptBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Save Receipt</button>
          </div>
        </form>
      </div>
    </div>

  </div>

  <!-- CLIENT HISTORY MODAL -->
  <div id="clientHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4" onclick="closeClientHistoryIfClickedOutside(event)">
    <div class="bg-white rounded-2xl p-8 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto" onclick="event.stopPropagation()">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-bold" id="clientHistoryTitle">Client History</h3>
        <button onclick="closeClientHistory()" class="text-gray-500 hover:text-gray-700 p-1 hover:bg-gray-100 rounded-full transition">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div id="clientHistoryContent"></div>
    </div>
  </div>

  <script>
    const supabase = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
    let revenueChart = null;
    let paymentChart = null;
    const currencySymbols = { 'MUR': 'Rs', 'USD': '$', 'EUR': 'â‚¬', 'GBP': 'Â£' };

    // Notification system
    function showNotification(message, type = 'info') {
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500'
      };
      
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 max-w-md`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
      }, 4000);
    }

    function msg(el, text, ok=false){ 
      el.textContent=text; 
      el.className='text-sm mt-2 '+(ok?'text-green-600':'text-red-600'); 
    }

    function renderAuthState(session){
      const signedIn = !!session?.user;
      document.getElementById('authCard').classList.toggle('hidden', signedIn);
      document.getElementById('navTabs').classList.toggle('hidden', !signedIn);
      document.getElementById('logoutBtn').classList.toggle('hidden', !signedIn);
      document.getElementById('userEmail').classList.toggle('hidden', !signedIn);
      if (signedIn) {
        document.getElementById('userEmail').textContent = session.user.email || '';
        showSection('receipts');
      }
    }

    supabase.auth.getSession().then(({ data }) => renderAuthState(data.session));
    supabase.auth.onAuthStateChange((_evt, session) => {
      renderAuthState(session);
      if (session) loadReceipts();
    });

    document.getElementById('signupBtn').onclick = async ()=>{
      const btn = document.getElementById('signupBtn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Creating...';
      
      const m=document.getElementById('authMsg');
      const email = document.getElementById('email').value.trim();
      const pass = document.getElementById('password').value.trim();
      const fullName = document.getElementById('fullName').value.trim();
      const bizName = document.getElementById('bizName').value.trim();
      const brn = document.getElementById('brn').value.toUpperCase().trim();
      const phone = document.getElementById('phone').value.trim();
      const address = document.getElementById('address').value.trim();

      if(!email || pass.length < 8 || !fullName || !bizName) {
        btn.disabled = false;
        btn.textContent = originalText;
        return msg(m,'Fill all required fields: email, password (8+ chars), full name, and business name');
      }

      const { data: signUp, error: signUpErr } = await supabase.auth.signUp({
        email, password: pass,
        options: { emailRedirectTo: location.origin }
      });
      
      if (signUpErr) {
        btn.disabled = false;
        btn.textContent = originalText;
        return msg(m, signUpErr.message);
      }

      const { error: insErr } = await supabase
        .from('business_profiles')
        .insert([{
          user_id: signUp.user?.id,
          email, full_name: fullName, business_name: bizName,
          brn, phone, address
        }]);
      
      btn.disabled = false;
      btn.textContent = originalText;
      
      if (insErr) return msg(m, insErr.message);

      msg(m,'Account created! Check your email to verify.', true);
      showNotification('Account created successfully! Please check your email.', 'success');
    };

    document.getElementById('loginBtn').onclick = async ()=>{
      const btn = document.getElementById('loginBtn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Logging in...';
      
      const m=document.getElementById('authMsg');
      const email = document.getElementById('email').value.trim();
      const pass = document.getElementById('password').value.trim();
      
      if(!email || pass.length < 8) {
        btn.disabled = false;
        btn.textContent = originalText;
        return msg(m,'Enter valid email and password (min 8 characters)');
      }

      const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
      
      btn.disabled = false;
      btn.textContent = originalText;
      
      if (error) return msg(m, error.message);
      
      msg(m,'Logged in!', true);
      showNotification('Welcome back!', 'success');
    };

    document.getElementById('logoutBtn').onclick = async ()=>{ 
      await supabase.auth.signOut();
      showNotification('Signed out successfully', 'info');
    };

    document.getElementById('resetPasswordBtn').onclick = async ()=>{
      const m=document.getElementById('authMsg');
      const email = document.getElementById('email').value.trim();
      if(!email) return msg(m,'Enter your email first');
      
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: location.origin
      });
      
      if (error) return msg(m, error.message);
      msg(m,'Password reset email sent! Check your inbox.', true);
      showNotification('Password reset email sent!', 'success');
    };

    function showSection(section) {
      ['authCard','dashboardSection','receiptsSection','clientsSection','createSection'].forEach(id => {
        document.getElementById(id).style.display = 'none';
      });
      ['dashboardBtn','receiptsBtn','clientsBtn'].forEach(id => {
        const btn = document.getElementById(id);
        if(btn) btn.className = 'px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition';
      });

      if (section === 'dashboard') {
        document.getElementById('dashboardSection').style.display = 'block';
        document.getElementById('dashboardBtn').className = 'px-4 py-2 bg-blue-100 text-blue-700 rounded-lg transition';
        loadDashboard();
      } else if (section === 'receipts') {
        document.getElementById('receiptsSection').style.display = 'block';
        document.getElementById('receiptsBtn').className = 'px-4 py-2 bg-blue-100 text-blue-700 rounded-lg transition';
        loadReceipts();
      } else if (section === 'clients') {
        document.getElementById('clientsSection').style.display = 'block';
        document.getElementById('clientsBtn').className = 'px-4 py-2 bg-blue-100 text-blue-700 rounded-lg transition';
        loadClients();
      } else if (section === 'create') {
        document.getElementById('createSection').style.display = 'block';
      }
    }

    async function loadDashboard() {
      const session = (await supabase.auth.getSession()).data.session;
      if (!session) return;
      
      const { data: receipts } = await supabase.from('receipts').select('*').eq('user_id', session.user.id);
      if (!receipts) return;
      
      const now = new Date();
      const thisMonth = receipts.filter(r => {
        const d = new Date(r.date);
        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
      });
      
      const monthRev = thisMonth.reduce((sum, r) => sum + Number(r.total || 0), 0);
      document.getElementById('monthRevenue').textContent = `Rs ${monthRev.toFixed(2)}`;
      document.getElementById('totalReceipts').textContent = receipts.length;
      
      const clients = new Set(receipts.map(r => r.client_name).filter(Boolean));
      document.getElementById('totalClients').textContent = clients.size;
      
      const unpaid = receipts.filter(r => !r.payment_status || r.payment_status === 'unpaid' || r.payment_status === 'partial');
      const unpaidAmount = unpaid.reduce((sum, r) => sum + Number(r.total || 0), 0);
      document.getElementById('unpaidAmount').textContent = `Rs ${unpaidAmount.toFixed(2)}`;
      
      const last6Months = [];
      for (let i = 5; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const monthReceipts = receipts.filter(r => {
          const rDate = new Date(r.date);
          return rDate.getMonth() === date.getMonth() && rDate.getFullYear() === date.getFullYear();
        });
        last6Months.push({
          month: date.toLocaleDateString('en', { month: 'short' }),
          revenue: monthReceipts.reduce((sum, r) => sum + Number(r.total || 0), 0)
        });
      }
      
      if (revenueChart) revenueChart.destroy();
      const ctx1 = document.getElementById('revenueChart').getContext('2d');
      revenueChart = new Chart(ctx1, {
        type: 'line',
        data: {
          labels: last6Months.map(m => m.month),
          datasets: [{
            label: 'Revenue (Rs)',
            data: last6Months.map(m => m.revenue),
            borderColor: 'rgb(59, 130, 246)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4
          }]
        },
        options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } } }
      });
      
      const paid = receipts.filter(r => r.payment_status === 'paid').length;
      const unpaidCount = receipts.filter(r => !r.payment_status || r.payment_status === 'unpaid').length;
      const partial = receipts.filter(r => r.payment_status === 'partial').length;
      
      if (paymentChart) paymentChart.destroy();
      const ctx2 = document.getElementById('paymentChart').getContext('2d');
      paymentChart = new Chart(ctx2, {
        type: 'doughnut',
        data: {
          labels: ['Paid', 'Unpaid', 'Partial'],
          datasets: [{
            data: [paid, unpaidCount, partial],
            backgroundColor: ['rgb(34, 197, 94)', 'rgb(239, 68, 68)', 'rgb(251, 191, 36)']
          }]
        },
        options: { responsive: true, maintainAspectRatio: true }
      });

      const clientTotals = {};
      receipts.forEach(r => {
        if (!clientTotals[r.client_name]) {
          clientTotals[r.client_name] = { total: 0, count: 0 };
        }
        clientTotals[r.client_name].total += Number(r.total || 0);
        clientTotals[r.client_name].count += 1;
      });
      
      const topClients = Object.entries(clientTotals)
        .sort((a, b) => b[1].total - a[1].total)
        .slice(0, 5);
      
      document.getElementById('topClients').innerHTML = topClients.length > 0 ? `
        <div class="space-y-3">
          ${topClients.map(([name, data]) => `
            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
              <div>
                <p class="font-medium">${name}</p>
                <p class="text-sm text-gray-600">${data.count} receipt${data.count !== 1 ? 's' : ''}</p>
              </div>
              <p class="text-lg font-bold">Rs ${data.total.toFixed(2)}</p>
            </div>
          `).join('')}
        </div>
      ` : '<p class="text-gray-500 text-center py-4">No clients yet</p>';
    }

    async function loadClients() {
      const session = (await supabase.auth.getSession()).data.session;
      if (!session) return;
      
      const { data: receipts } = await supabase.from('receipts').select('*').eq('user_id', session.user.id);
      
      if (!receipts || receipts.length === 0) {
        document.getElementById('clientsList').innerHTML = '<p class="text-gray-500 text-center py-8">No clients yet. Create your first receipt to see clients here!</p>';
        return;
      }
      
      const clientData = {};
      receipts.forEach(r => {
        if (!clientData[r.client_name]) {
          clientData[r.client_name] = {
            name: r.client_name,
            email: r.client_email || '',
            phone: r.client_phone || '',
            receipts: [],
            total: 0
          };
        }
        clientData[r.client_name].receipts.push(r);
        clientData[r.client_name].total += Number(r.total || 0);
      });
      
      const clients = Object.values(clientData).sort((a, b) => b.total - a.total);
      window.clientsData = clients;
      
      document.getElementById('clientsList').innerHTML = `
        <div class="grid gap-4">
          ${clients.map((client, index) => `
            <div class="border-2 rounded-xl p-6 hover:shadow-lg transition cursor-pointer bg-white hover:border-blue-300" onclick="showClientHistory(${index})">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <h3 class="font-bold text-xl text-gray-900 mb-2">${client.name}</h3>
                  <div class="space-y-1">
                    ${client.email ? `<p class="text-sm text-gray-600 flex items-center gap-2"><span>ðŸ“§</span> ${client.email}</p>` : ''}
                    ${client.phone ? `<p class="text-sm text-gray-600 flex items-center gap-2"><span>ðŸ“±</span> ${client.phone}</p>` : ''}
                  </div>
                </div>
                <div class="text-right ml-4">
                  <p class="text-2xl font-bold text-green-600 mb-1">Rs ${client.total.toFixed(2)}</p>
                  <p class="text-sm text-gray-600 mb-3">${client.receipts.length} receipt${client.receipts.length !== 1 ? 's' : ''}</p>
                  <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-medium">
                    View All Receipts â†’
                  </button>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function showClientHistory(clientIndex) {
      if (!window.clientsData || !window.clientsData[clientIndex]) {
        showNotification('Client not found', 'error');
        return;
      }
      
      const client = window.clientsData[clientIndex];
      const clientReceipts = client.receipts.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      document.getElementById('clientHistoryTitle').textContent = `${client.name} - Receipt History (${clientReceipts.length} total)`;
      
      document.getElementById('clientHistoryContent').innerHTML = clientReceipts.length > 0 ? `
        <div class="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <p class="text-sm text-gray-600">Total Spent</p>
              <p class="text-2xl font-bold text-blue-600">Rs ${client.total.toFixed(2)}</p>
            </div>
            <div>
              <p class="text-sm text-gray-600">Total Receipts</p>
              <p class="text-2xl font-bold text-gray-900">${clientReceipts.length}</p>
            </div>
          </div>
        </div>
        
        <div class="space-y-4">
          ${clientReceipts.map(r => `
            <div class="border-2 rounded-xl p-5 hover:shadow-md transition bg-white">
              <div class="flex justify-between items-start gap-4">
                <div class="flex-1">
                  <div class="flex items-center gap-3 mb-3">
                    <p class="font-bold text-xl text-gray-900">${r.reference_number}</p>
                    <span class="px-3 py-1 rounded-full text-xs font-bold ${
                      r.payment_status === 'paid' ? 'bg-green-100 text-green-800' : 
                      r.payment_status === 'unpaid' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'
                    }">
                      ${(r.payment_status || 'unpaid').toUpperCase()}
                    </span>
                  </div>
                  
                  <p class="text-sm text-gray-600 mb-3">
                    ðŸ“… ${new Date(r.date).toLocaleDateString('en-GB', { 
                      day: '2-digit', 
                      month: 'long', 
                      year: 'numeric',
                      weekday: 'short'
                    })}
                  </p>
                  
                  <div class="bg-gray-50 rounded-lg p-3 mb-3">
                    <p class="text-xs font-semibold text-gray-500 uppercase mb-2">Items Purchased:</p>
                    ${(r.items || []).map(item => `
                      <div class="flex justify-between text-sm py-1">
                        <span class="text-gray-700">â€¢ ${item.name}</span>
                        <span class="text-gray-600">${item.qty}x @ Rs ${Number(item.price).toFixed(2)}</span>
                      </div>
                    `).join('')}
                  </div>
                </div>
                
                <div class="text-right">
                  <p class="text-3xl font-bold text-gray-900 mb-4">
                    Rs ${Number(r.total).toFixed(2)}
                  </p>
                  <div class="flex flex-col gap-2">
                    <button onclick="downloadPDF('${r.id}')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium text-sm whitespace-nowrap">
                      ðŸ“¥ Download PDF
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      ` : '<p class="text-gray-500 text-center py-8">No receipts for this client</p>';
      
      document.getElementById('clientHistoryModal').classList.remove('hidden');
      document.getElementById('clientHistoryModal').classList.add('flex');
    }

    function closeClientHistory() {
      document.getElementById('clientHistoryModal').classList.add('hidden');
      document.getElementById('clientHistoryModal').classList.remove('flex');
    }

    function closeClientHistoryIfClickedOutside(event) {
      if (event.target === document.getElementById('clientHistoryModal')) {
        closeClientHistory();
      }
    }

    async function loadReceipts() {
      const session = (await supabase.auth.getSession()).data.session;
      if (!session) return;
      
      const { data, error } = await supabase
        .from('receipts')
        .select('*')
        .eq('user_id', session.user.id)
        .order('created_at', { ascending: false })
        .limit(50);
      
      if (error) { 
        console.error(error); 
        showNotification('Error loading receipts', 'error');
        return;
      }
      
      if (!data || data.length === 0) {
        document.getElementById('receiptsTable').innerHTML = '<div class="text-center py-12"><p class="text-gray-500 text-lg mb-4">No receipts yet. Create your first receipt!</p><button onclick="showSection(\'create\')" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Create Your First Receipt</button></div>';
        return;
      }
      
      document.getElementById('receiptsTable').innerHTML = `
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Reference</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Client</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            ${data.map(r => `
              <tr class="hover:bg-gray-50">
                <td class="px-4 py-3 text-sm text-gray-900">${new Date(r.date).toLocaleDateString()}</td>
                <td class="px-4 py-3 text-sm font-medium text-gray-900">${r.reference_number}</td>
                <td class="px-4 py-3 text-sm text-gray-900">${r.client_name || '-'}</td>
                <td class="px-4 py-3 text-sm text-gray-900">Rs ${Number(r.total).toFixed(2)}</td>
                <td class="px-4 py-3 text-sm">
                  <span class="px-2 py-1 rounded text-xs font-medium ${
                    r.payment_status === 'paid' ? 'bg-green-100 text-green-800' :
                    r.payment_status === 'partial' ? 'bg-yellow-100 text-yellow-800' :
                    'bg-red-100 text-red-800'
                  }">
                    ${(r.payment_status || 'unpaid').toUpperCase()}
                  </span>
                </td>
                <td class="px-4 py-3 text-sm">
                  <button onclick="downloadPDF('${r.id}')" class="text-blue-600 hover:underline">ðŸ“¥ Download</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function addItemRow() {
      const container = document.getElementById('itemsContainer');
      const itemId = Date.now() + Math.random();
      const itemRow = document.createElement('div');
      itemRow.className = 'grid grid-cols-12 gap-3 mb-3 items-end';
      itemRow.id = `item-${itemId}`;
      itemRow.innerHTML = `
        <div class="col-span-12 md:col-span-5">
          <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
          <input type="text" class="item-description w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Item description" required oninput="calculateTotal()" />
        </div>
        <div class="col-span-6 md:col-span-2">
          <label class="block text-sm font-medium text-gray-700 mb-1">Qty</label>
          <input type="number" class="item-quantity w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" value="1" min="1" required oninput="calculateTotal()" />
        </div>
        <div class="col-span-6 md:col-span-3">
          <label class="block text-sm font-medium text-gray-700 mb-1">Price</label>
          <input type="number" class="item-price w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" value="0" min="0" step="0.01" required oninput="calculateTotal()" />
        </div>
        <div class="col-span-12 md:col-span-2">
          <button type="button" onclick="removeItem('${itemId}')" class="w-full px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition">Remove</button>
        </div>
      `;
      container.appendChild(itemRow);
      calculateTotal();
    }

    function removeItem(itemId) {
      document.getElementById(`item-${itemId}`).remove();
      calculateTotal();
    }

    function calculateTotal() {
      const items = document.querySelectorAll('#itemsContainer > div');
      let total = 0;
      items.forEach(item => {
        const quantity = parseFloat(item.querySelector('.item-quantity').value) || 0;
        const price = parseFloat(item.querySelector('.item-price').value) || 0;
        total += quantity * price;
      });
      const currency = document.getElementById('currency').value;
      document.getElementById('currencySymbol').textContent = currencySymbols[currency];
      document.getElementById('totalAmount').textContent = total.toFixed(2);
    }

    function getReceiptItems() {
      const items = [];
      document.querySelectorAll('#itemsContainer > div').forEach(row => {
        const description = row.querySelector('.item-description').value.trim();
        const quantity = parseFloat(row.querySelector('.item-quantity').value);
        const price = parseFloat(row.querySelector('.item-price').value);
        if (description && quantity > 0 && price >= 0) {
          items.push({ name: description, qty: quantity, price });
        }
      });
      return items;
    }

    async function saveReceipt(event) {
      event.preventDefault();
      
      const btn = document.getElementById('saveReceiptBtn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Saving...';
      
      const session = (await supabase.auth.getSession()).data.session;
      if (!session) {
        btn.disabled = false;
        btn.textContent = originalText;
        showNotification('Please sign in first', 'error');
        return;
      }

      const items = getReceiptItems();
      if (items.length === 0) {
        btn.disabled = false;
        btn.textContent = originalText;
        showNotification('Add at least one item', 'warning');
        return;
      }

      const total = parseFloat(document.getElementById('totalAmount').textContent);
      const payload = {
        user_id: session.user.id,
        reference_number: 'BMP-' + Date.now().toString().slice(-8),
        client_name: document.getElementById('clientName').value.trim(),
        client_email: document.getElementById('clientEmail').value.trim(),
        client_phone: document.getElementById('clientPhone').value.trim(),
        date: new Date().toISOString(),
        subtotal: total,
        tax: 0,
        discount: 0,
        total,
        items,
        payment_status: document.getElementById('paymentStatus').value
      };

      const { error } = await supabase.from('receipts').insert([payload]);
      
      btn.disabled = false;
      btn.textContent = originalText;
      
      if (error) {
        console.error(error);
        showNotification('Error saving receipt: ' + error.message, 'error');
        return;
      }

      showNotification('Receipt saved successfully! ðŸŽ‰', 'success');
      document.getElementById('receiptForm').reset();
      document.getElementById('itemsContainer').innerHTML = '';
      addItemRow();
      showSection('receipts');
    }

    window.downloadPDF = async function(receiptId) {
      showNotification('Generating PDF...', 'info');
      
      try {
        const { data: receipt } = await supabase.from('receipts').select('*').eq('id', receiptId).single();
        if (!receipt) {
          showNotification('Receipt not found', 'error');
          return;
        }
        
        const { data: profile } = await supabase.from('business_profiles').select('*').eq('user_id', receipt.user_id).single();
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFillColor(41, 98, 255);
        doc.rect(0, 0, 210, 40, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(28);
        doc.text('RECEIPT', 20, 25);
        
        doc.setFontSize(10);
        doc.text(profile?.business_name || 'Business Manager Pro', 20, 33);
        
        const statusColor = receipt.payment_status === 'paid' ? [34, 197, 94] : 
                           receipt.payment_status === 'partial' ? [251, 191, 36] : [239, 68, 68];
        doc.setFillColor(...statusColor);
        doc.roundedRect(150, 15, 40, 10, 2, 2, 'F');
        doc.setFontSize(9);
        doc.text((receipt.payment_status || 'UNPAID').toUpperCase(), 170, 21, { align: 'center' });
        
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(10);
        doc.text(`Receipt #: ${receipt.reference_number}`, 20, 55);
        doc.text(`Date: ${new Date(receipt.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' })}`, 20, 62);
        
        doc.setFillColor(245, 245, 245);
        doc.roundedRect(20, 70, 170, 25, 3, 3, 'F');
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        doc.text('BILL TO:', 25, 77);
        doc.setFontSize(11);
        doc.setTextColor(0, 0, 0);
        doc.text(receipt.client_name || '-', 25, 84);
        doc.setFontSize(9);
        if (receipt.client_email) doc.text(receipt.client_email, 25, 89);
        if (receipt.client_phone) doc.text(receipt.client_phone, 25, 93);
        
        doc.setFontSize(9);
        doc.setFillColor(240, 240, 240);
        doc.rect(20, 105, 170, 8, 'F');
        doc.setTextColor(0, 0, 0);
        doc.text('DESCRIPTION', 25, 110);
        doc.text('QTY', 115, 110, { align: 'center' });
        doc.text('PRICE', 145, 110, { align: 'right' });
        doc.text('AMOUNT', 185, 110, { align: 'right' });
        
        let y = 120;
        (receipt.items || []).forEach(item => {
          doc.text(item.name || '-', 25, y);
          doc.text((item.qty || 1).toString(), 115, y, { align: 'center' });
          doc.text(`Rs ${Number(item.price || 0).toFixed(2)}`, 145, y, { align: 'right' });
          doc.text(`Rs ${((item.qty || 1) * Number(item.price || 0)).toFixed(2)}`, 185, y, { align: 'right' });
          y += 7;
        });
        
        doc.setFillColor(0, 0, 0);
        doc.roundedRect(130, y + 10, 60, 15, 3, 3, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(11);
        doc.text('TOTAL', 140, y + 18);
        doc.setFontSize(14);
        doc.text(`Rs ${Number(receipt.total).toFixed(2)}`, 180, y + 19, { align: 'right' });
        
        doc.setTextColor(100, 100, 100);
        doc.setFontSize(9);
        doc.text('Thank you for your business!', 105, y + 40, { align: 'center' });
        doc.setFontSize(7);
        doc.text('Generated by Business Manager Pro', 105, y + 46, { align: 'center' });
        
        doc.save(`${receipt.reference_number}.pdf`);
        showNotification('PDF downloaded successfully!', 'success');
      } catch (error) {
        console.error(error);
        showNotification('Error generating PDF', 'error');
      }
    }

    document.getElementById('exportCsvBtn').onclick = async () => {
      const session = (await supabase.auth.getSession()).data.session;
      if (!session) return;
      
      const { data: receipts } = await supabase.from('receipts').select('*').eq('user_id', session.user.id);
      if (!receipts || receipts.length === 0) {
        showNotification('No receipts to export', 'warning');
        return;
      }
      
      const headers = ['Date', 'Reference', 'Client', 'Email', 'Phone', 'Items', 'Total', 'Status'];
      const rows = receipts.map(r => [
        new Date(r.date).toLocaleDateString(),
        r.reference_number,
        r.client_name || '',
        r.client_email || '',
        r.client_phone || '',
        (r.items || []).map(i => i.name).join('; '),
        r.total || 0,
        r.payment_status || 'unpaid'
      ]);
      
      let csvContent = headers.join(',') + '\n';
      rows.forEach(row => csvContent += row.map(cell => `"${cell}"`).join(',') + '\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `receipts-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      
      showNotification('CSV exported successfully!', 'success');
    };

    function generateMonthlyReport() {
      showNotification('Monthly report feature coming soon!', 'info');
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      addItemRow();
    });
  </script>
</body>
</html>
