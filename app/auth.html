<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sign in · Business Manager Pro</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
<style>
  .container { max-width: 560px; padding-top: 32px; }
  .muted { color:#6b7280; font-size:12px }
  .hidden { display:none !important; }
  .err { color:#dc2626; }
  .ok { color:#16a34a; }
</style>
</head>
<body>
<main class="container">
  <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
    <h1 style="margin:0;">Business Manager Pro</h1>
    <a href="/app/">Dashboard</a>
  </header>

  <p id="status" class="muted"></p>

  <!-- LOGIN / SIGNUP -->
  <article id="authCard">
    <nav style="display:flex;gap:10px;margin-bottom:12px;">
      <button id="tabLogin" class="contrast">Login</button>
      <button id="tabSignup" class="secondary">Create account</button>
    </nav>

    <form id="loginForm" class="grid" style="gap:12px;">
      <label>Email <input id="loginEmail" type="email" required autocomplete="username" /></label>
      <label>Password <input id="loginPwd" type="password" required autocomplete="current-password" /></label>
      <button type="submit" id="loginBtn">Sign in</button>
      <small><a href="#" id="forgotLink">Forgot password?</a></small>
      <small id="loginErr" class="err"></small>
    </form>

    <form id="signupForm" class="grid hidden" style="gap:12px;">
      <label>Email <input id="signupEmail" type="email" required autocomplete="username" /></label>
      <label>Password <input id="signupPwd" type="password" required autocomplete="new-password" minlength="6"/></label>
      <button type="submit" id="signupBtn">Create account</button>
      <small id="signupErr" class="err"></small>
      <small class="muted">You may receive a confirmation email.</small>
    </form>

    <hr />

    <form id="magicForm" class="grid" style="gap:12px;">
      <label>Or get a magic link <input id="magicEmail" type="email" required /></label>
      <button type="submit" id="magicBtn">Send magic link</button>
      <small id="magicMsg" class="muted"></small>
    </form>
  </article>

  <!-- FORGOT PASSWORD REQUEST -->
  <article id="forgotCard" class="hidden">
    <h3>Reset your password</h3>
    <form id="forgotForm" class="grid" style="gap:12px;">
      <label>Email <input id="forgotEmail" type="email" required /></label>
      <button type="submit" id="forgotBtn">Send reset link</button>
      <small class="muted">We’ll email you a link. After clicking, you’ll come back here to set a new password.</small>
      <small id="forgotErr" class="err"></small>
      <small id="forgotOk" class="ok"></small>
    </form>
    <small><a href="#" id="backToLogin">← Back to login</a></small>
  </article>

  <!-- PASSWORD RESET (after email link) -->
  <article id="resetCard" class="hidden">
    <h3>Set a new password</h3>
    <form id="resetForm" class="grid" style="gap:12px;">
      <label>New password <input id="newPwd" type="password" required minlength="6" autocomplete="new-password" /></label>
      <button type="submit" id="resetBtn">Update password</button>
      <small id="resetMsg" class="muted"></small>
    </form>
  </article>

</main>

<script src="https://esm.sh/@supabase/supabase-js@2"></script>
<script>
/* ===== CONFIG: fill these from Supabase Settings → API ===== */
const SUPABASE_URL = "YOUR_SUPABASE_URL";
const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";
/* ========================================================== */

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: {
    persistSession: true,         // keep users signed in
    autoRefreshToken: true,
    detectSessionInUrl: true
  }
});

const statusEl = document.getElementById("status");
const authCard = document.getElementById("authCard");
const forgotCard = document.getElementById("forgotCard");
const resetCard = document.getElementById("resetCard");

function setStatus(msg, cls="muted"){ statusEl.textContent = msg || ""; statusEl.className = cls; }
function show(el){ el.classList.remove("hidden"); }
function hide(el){ el.classList.add("hidden"); }
function loading(btn, on){ if(!btn) return; btn.disabled = !!on; btn.dataset.prev ??= btn.textContent; btn.textContent = on ? "Please wait…" : btn.dataset.prev; }

/* ===== Handle hash-style links: #access_token=... (magic/recovery) ===== */
async function handleHashTokensIfAny() {
  if (!location.hash) return;
  const hash = new URLSearchParams(location.hash.slice(1));
  const access_token  = hash.get("access_token");
  const refresh_token = hash.get("refresh_token");
  const type          = hash.get("type"); // optional: "recovery"
  if (!access_token || !refresh_token) return;

  const { error } = await sb.auth.setSession({ access_token, refresh_token });
  if (error) { setStatus(error.message || "Invalid or expired link.", "err"); return; }

  // Clean hash to avoid re-running on refresh
  history.replaceState(null, "", location.pathname + location.search);

  if (type === "recovery") {
    setStatus("Link verified. Set a new password below.");
    hide(authCard); hide(forgotCard); show(resetCard);
  } else {
    // Magic link / confirmation
    location.href = "/app/";
  }
}

/* ===== Handle code-style links: ?code=...&type=recovery ===== */
async function handleEmailLinksIfAny() {
  const url = new URL(window.location.href);
  const code = url.searchParams.get("code");
  const type = url.searchParams.get("type"); // 'recovery' for reset
  if (!code) return;

  try {
    setStatus("Signing you in…");
    const { error } = await sb.auth.exchangeCodeForSession({ code });
    if (error) throw error;

    if (type === "recovery") {
      setStatus("Link verified. Set a new password below.");
      hide(authCard); hide(forgotCard); show(resetCard);
    } else {
      setStatus("Signed in. Redirecting…");
      location.href = "/app/"; // already logged in by magic link
    }
  } catch (err) {
    console.error(err);
    setStatus(err.message || "Link expired or invalid.", "err");
    show(authCard); hide(forgotCard); hide(resetCard);
  }
}

/* ===== Tabs ===== */
document.getElementById("tabLogin").addEventListener("click", () => {
  document.getElementById("loginForm").classList.remove("hidden");
  document.getElementById("signupForm").classList.add("hidden");
  setStatus("");
});
document.getElementById("tabSignup").addEventListener("click", () => {
  document.getElementById("loginForm").classList.add("hidden");
  document.getElementById("signupForm").classList.remove("hidden");
  setStatus("");
});

/* ===== Login with feedback ===== */
document.getElementById("loginForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const email = document.getElementById("loginEmail").value.trim();
  const password = document.getElementById("loginPwd").value;
  const btn = document.getElementById("loginBtn");
  const err = document.getElementById("loginErr");
  err.textContent = ""; setStatus(""); loading(btn, true);

  try {
    const { error } = await sb.auth.signInWithPassword({ email, password });
    if (error) { err.textContent = error.message || "Invalid email or password."; return; }
    location.href = "/app/"; // success
  } catch (ex) {
    err.textContent = ex.message || "Login failed.";
  } finally {
    loading(btn, false);
  }
});

/* ===== Signup with feedback ===== */
document.getElementById("signupForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const email = document.getElementById("signupEmail").value.trim();
  const password = document.getElementById("signupPwd").value;
  const btn = document.getElementById("signupBtn");
  const err = document.getElementById("signupErr");
  err.textContent = ""; setStatus(""); loading(btn, true);

  try {
    const { error } = await sb.auth.signUp({ email, password });
    if (error) { err.textContent = error.message; return; }
    setStatus("Check your inbox to confirm (if confirmations are enabled).", "ok");
  } catch (ex) {
    err.textContent = ex.message || "Signup failed.";
  } finally {
    loading(btn, false);
  }
});

/* ===== Magic link ===== */
document.getElementById("magicForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const email = document.getElementById("magicEmail").value.trim();
  const btn = document.getElementById("magicBtn");
  const msg = document.getElementById("magicMsg");
  msg.textContent = ""; loading(btn, true);

  try {
    // Works for both auth.html and hash routes
    const redirectTo = `${location.origin}/app/auth.html`;
    const { error } = await sb.auth.signInWithOtp({ email, options: { emailRedirectTo: redirectTo } });
    if (error) throw error;
    msg.textContent = "Magic link sent. Check your email.";
  } catch (ex) {
    msg.textContent = ex.message || "Could not send magic link.";
  } finally {
    loading(btn, false);
  }
});

/* ===== Forgot password request with feedback ===== */
document.getElementById("forgotLink").addEventListener("click", (e) => {
  e.preventDefault(); hide(authCard); show(forgotCard); hide(resetCard); setStatus("");
});
document.getElementById("backToLogin").addEventListener("click", (e) => {
  e.preventDefault(); show(authCard); hide(forgotCard); hide(resetCard); setStatus("");
});
document.getElementById("forgotForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const email = document.getElementById("forgotEmail").value.trim();
  const btn = document.getElementById("forgotBtn");
  const err = document.getElementById("forgotErr");
  const ok  = document.getElementById("forgotOk");
  err.textContent = ""; ok.textContent = ""; loading(btn, true);

  try {
    const redirectTo = `${location.origin}/app/auth.html?type=recovery`;
    const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo });
    if (error) throw error;
    ok.textContent = "Reset link sent. Open your email.";
  } catch (ex) {
    err.textContent = ex.message || "Could not send reset link.";
  } finally {
    loading(btn, false);
  }
});

/* ===== Complete password reset ===== */
document.getElementById("resetForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const newPwd = document.getElementById("newPwd").value;
  const btn = document.getElementById("resetBtn");
  const msg = document.getElementById("resetMsg");
  msg.textContent = ""; loading(btn, true);

  try {
    const { error } = await sb.auth.updateUser({ password: newPwd });
    if (error) throw error;
    msg.textContent = "Password updated. Redirecting…";
    setTimeout(() => location.href = "/app/", 900);
  } catch (ex) {
    msg.textContent = ex.message || "Could not update password.";
  } finally {
    loading(btn, false);
  }
});

/* ===== Boot: handle BOTH link styles ===== */
document.addEventListener("DOMContentLoaded", async () => {
  await handleHashTokensIfAny();   // handles #access_token=...
  await handleEmailLinksIfAny();   // handles ?code=...
});
</script>
</body>
</html>
